{% extends "base.html" %}
{% block content %}

<h2>Goat Profile: {{ goat.tag }}</h2>

{% set min_age = 60 %}
{% if age_days >= min_age and not has_any_vaccine %}
  <div class="alert alert-warning mb-3">
    ‚ö†Ô∏è <b>No vaccination history found for this goat.</b>
    <br>
    Please <a href="{{ url_for('vaccine.batch_vaccine_entry') }}" class="alert-link">record initial vaccinations</a>
    to enable correct future scheduling.
  </div>
{% endif %}
<table class="table table-bordered w-auto">
  <tr><th>Tag</th><td>{{ goat.tag }}</td></tr>
  <tr><th>Type/Breed</th><td>{{ goat.goat_type.name if goat.goat_type else '-' }}</td></tr>
  <tr><th>Sex</th><td>{{ goat.sex or "-" }}</td></tr>
  <tr><th>Date Acquired</th><td>{{ goat.date_acquired or "-" }}</td></tr>
  <tr><th>Acquisition Method</th><td>{{ goat.acquisition_method or "-" }}</td></tr>
  <tr><th>Source/Seller</th><td>{{ goat.source_name or "-" }}</td></tr>
  <tr><th>Purchase Price (RM)</th>
    <td>
      {% if goat.purchase_price %}{{ '%.2f'|format(goat.purchase_price) }}{% else %}-{% endif %}
    </td>
  </tr>
  <tr><th>Date of Birth</th><td>{{ goat.dob or "-" }}</td></tr>
  <tr><th>Estimated Age at Acquisition (months)</th><td>{{ goat.age_estimate_months or "-" }}</td></tr>
  <tr>
    <th>Weight (kg)</th>
    <td>
      {{ goat.weight or "-" }}
      {# Underweight Alert right below weight #}
      {% set target = get_target_weight(goat) %}
      {% if target and goat.weight and goat.weight < target %}
        <div class="alert alert-danger my-2 p-1 mb-0">
          ‚ö†Ô∏è Underweight! (Current: {{ goat.weight }} kg, Target ‚â• {{ target }} kg for {{ goat.goat_type.name if goat.goat_type else '-' }})
        </div>
      {% endif %}
    </td>
  </tr>
  <tr><th>Location/Room</th><td>{{ goat.location or "-" }}</td></tr>
  <tr><th>Status</th>
    <td>
    {% for tag in goat.tags %}
      <span class="badge
        {% if tag == 'sick' %}bg-danger
        {% elif tag == 'underweight' %}bg-warning text-dark
        {% elif tag == 'pregnant' %}bg-info
        {% elif tag == 'ready to mate' %}bg-success
        {% elif tag == 'new arrival' or tag == 'new born' %}bg-primary
        {% elif tag == 'old' %}bg-secondary
        {% elif tag == 'matured' %}bg-success
        {% else %}bg-dark
        {% endif %}
      ">{{ tag|capitalize }}</span>
    {% endfor %}

    {# Recommended: Mark as Recovered button if sick #}
    {% if 'sick' in goat.tags %}
      <form method="post" action="{{ url_for('goats.mark_goat_recovered', tag=goat.tag) }}" class="d-inline ms-2">
        <button type="submit" class="btn btn-sm btn-outline-success my-2">
          Mark as Recovered
        </button>
      </form>
    {% endif %}
    </td>
  </tr>
  <tr><th>Notes</th><td>{{ goat.notes or "-" }}</td></tr>
</table>

<h3>Weight History</h3>
<table class="table table-bordered">
  <thead>
    <tr>
      <th>Date</th>
      <th>Weight (kg)</th>
      <th>Recorded By</th>
      <th>Recorded At</th>
    </tr>
  </thead>
  <tbody>
    {% for log in weight_logs.items %}
      <tr>
        <td>{{ log.date }}</td>
        <td>{{ log.weight }}</td>
        <td>{{ log.created_by or '-' }}</td>
        <td>{{ log.created_at.strftime('%d-%m-%Y %H:%M') if log.created_at else '-' }}</td>
      </tr>
    {% else %}
      <tr><td colspan="4" class="text-muted">No weights recorded yet.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Pagination Controls -->
<nav>
  <ul class="pagination justify-content-center">
    {% if weight_logs.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('goats.goat_detail', tag=goat.tag, weight_page=weight_logs.prev_num) }}">Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}

    {% for page_num in weight_logs.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
      {% if page_num %}
        {% if page_num == weight_logs.page %}
          <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="{{ url_for('goats.goat_detail', tag=goat.tag, weight_page=page_num) }}">{{ page_num }}</a></li>
        {% endif %}
      {% else %}
        <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
      {% endif %}
    {% endfor %}

    {% if weight_logs.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('goats.goat_detail', tag=goat.tag, weight_page=weight_logs.next_num) }}">Next</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>

<canvas id="weightChart" height="120"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const weightData = {
  labels: [{% for log in goat.weight_logs|sort(attribute='date') %}"{{ log.date }}",{% endfor %}],
  datasets: [{
    label: "Weight (kg)",
    data: [{% for log in goat.weight_logs|sort(attribute='date') %}{{ log.weight }},{% endfor %}],
    borderColor: "#198754",
    tension: 0.2,
    fill: false
  }]
};
const ctx = document.getElementById('weightChart').getContext('2d');
new Chart(ctx, { type: 'line', data: weightData });
</script>

<!-- Add Weight Entry Form -->
<form method="post" action="{{ url_for('goats.add_weight_log', tag=goat.tag) }}">
  <div class="row g-2">
    <div class="col-auto">
      <input type="date" name="date" class="form-control" value="{{ now.strftime('%Y-%m-%d') }}" required>
    </div>
    <div class="col-auto">
      <input type="number" step="0.01" name="weight" class="form-control" placeholder="Weight (kg)" required>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-success">Add Weight</button>
    </div>
  </div>
</form>

<h3>Vaccination/Deworming History</h3>
<table class="table table-striped">
  <thead>
    <tr>
      <th>Vaccine</th>
      <th>Scheduled Date</th>
      <th>Actual Date Given</th>
      <th>Status</th>
      <th>Batch #</th>
      <th>Given By</th>
      <th>Logged By</th>
      <th>Logged At</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>
    {% for v in vaccine_events.items %}
      <tr>
        <td>{{ v.vaccine_type.name }}</td>
        <td>{{ v.scheduled_date }}</td>
        <td>{{ v.actual_date_given or "-" }}</td>
        <td>
          {% if v.status == "done" %}
            <span class="badge bg-success">Done</span>
          {% elif v.status == "overdue" %}
            <span class="badge bg-danger">Overdue</span>
          {% else %}
            <span class="badge bg-warning text-dark">Scheduled</span>
          {% endif %}
        </td>
        <td>{{ v.batch_number or '-' }}</td>
        <td>{{ v.given_by or '-' }}</td>
        <td>{{ v.created_by or '-' }}</td>
        <td>{{ v.created_at.strftime('%d-%m-%Y %H:%M') if v.created_at else '-' }}</td>
        <td>{{ v.notes or "-" }}</td>
      </tr>
    {% else %}
      <tr><td colspan="9" class="text-muted">No vaccination history yet.</td></tr>
    {% endfor %}
  </tbody>
</table>
<nav>
  <ul class="pagination justify-content-center">
    {% if vaccine_events.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('goats.goat_detail', tag=goat.tag, vaccine_page=vaccine_events.prev_num) }}#vaccine">Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}
    {% for page_num in vaccine_events.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
      {% if page_num %}
        {% if page_num == vaccine_events.page %}
          <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="{{ url_for('goats.goat_detail', tag=goat.tag, vaccine_page=page_num) }}#vaccine">{{ page_num }}</a></li>
        {% endif %}
      {% else %}
        <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
      {% endif %}
    {% endfor %}
    {% if vaccine_events.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('goats.goat_detail', tag=goat.tag, vaccine_page=vaccine_events.next_num) }}#vaccine">Next</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>


<hr>

<h3>Upcoming Vaccination/Deworming Schedule</h3>
<table class="table">
  <tr>
    <th>Vaccine</th>
    <th>Last Given</th>
    <th>Next Due</th>
    <th>Status</th>
    <th>Action</th>
  </tr>
  {% for v in vaccine_due_info %}
    <tr>
      <td>{{ v.vaccine.name }}</td>
      <td>{{ v.last_given or "Never" }}</td>
      <td>{{ v.next_due.strftime('%d-%m-%Y') }}</td>
      <td>
        {% if v.status == "overdue" %}
          <span class="badge bg-danger">Overdue</span>
        {% elif v.status == "due" %}
          <span class="badge bg-warning text-dark">Due Soon</span>
        {% else %}
          <span class="badge bg-success">Scheduled</span>
        {% endif %}
      </td>
      <td>
        {% if v.status in ["due", "overdue"] %}
          <a href="{{ url_for('vaccine.record_vaccine', tag=goat.tag, vaccine_type_id=v.vaccine.id) }}"
            class="btn btn-sm btn-outline-success">
            Mark as Done
          </a>
          <!-- Reschedule Button & Modal -->
          <button class="btn btn-sm btn-outline-warning"
                  data-bs-toggle="modal"
                  data-bs-target="#rescheduleModal-{{ v.vaccine.id }}-{{ v.next_due.strftime('%Y%m%d') }}">
            Reschedule
          </button>
          <div class="modal fade" id="rescheduleModal-{{ v.vaccine.id }}-{{ v.next_due.strftime('%Y%m%d') }}" tabindex="-1">
            <div class="modal-dialog">
              <form id="rescheduleForm-{{ v.vaccine.id }}-{{ v.next_due.strftime('%Y%m%d') }}" method="post"
                    action="{{ url_for('goats.reschedule_vaccine', tag=goat.tag, vaccine_type_id=v.vaccine.id) }}">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Reschedule {{ v.vaccine.name }} for {{ goat.tag }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <label>New Next Due Date:</label>
                    <input type="date" class="form-control" name="new_date"
                      value="{{ v.next_due.strftime('%Y-%m-%d') }}" required>
                    <div class="small text-muted mt-1">All future schedules will shift to keep interval spacing.</div>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-warning">Reschedule</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        {% elif v.status == "scheduled" %}
          <span class="text-muted">Awaiting next due date</span>
        {% endif %}
      </td>
    </tr>
  {% endfor %}

</table>


<!-- ALERT BADGES FOR DOES -->
{% if goat.sex == "Female" and goat.status == "active" %}
  {% set last_breeding = goat.breedings_as_doe|sort(attribute="mating_end_date")|last %}
  {% if last_breeding %}
    {% set last_end = last_breeding.mating_end_date %}
    {% set days_since = (now.date() - last_end|todate("%Y-%m-%d")).days %}
    {% if days_since >= 21 %}
      <span class="badge bg-warning text-dark mb-2">Ready for Re-Mating ({{ days_since }} days since last mating)</span>
    {% else %}
      <span class="badge bg-info text-dark mb-2">Next check in {{ 21 - days_since }} days</span>
    {% endif %}
  {% else %}
    <span class="badge bg-success mb-2">Never mated ‚Äî Ready for First Mating</span>
  {% endif %}
{% endif %}

<!-- BREEDING HISTORY (Doe & Buck) -->
{% if goat.sex in ["Female", "Male"] %}
<h4 class="mt-4">Breeding Events (History)</h4>
<table class="table table-sm table-striped w-auto">
  <thead>
    <tr>
      <th>Date (Start-End)</th>
      <th>Buck</th>
      <th>Doe</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>
    {% for event in breeding_events.items %}
    <tr>
      <td>{{ event.mating_start_date }}{% if event.mating_end_date %} &ndash; {{ event.mating_end_date }}{% endif %}</td>
      <td>{{ event.buck.tag if event.buck else "-" }}</td>
      <td>{{ event.doe.tag if event.doe else "-" }}</td>
      <td>{{ event.notes or "-" }}</td>
    </tr>
    {% else %}
    <tr><td colspan="4" class="text-muted">No breeding history</td></tr>
    {% endfor %}
  </tbody>
</table>
<nav>
  <ul class="pagination justify-content-center">
    {% if breeding_events.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('goats.goat_detail', tag=goat.tag, breeding_page=breeding_events.prev_num) }}#breeding">Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}
    {% for page_num in breeding_events.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
      {% if page_num %}
        {% if page_num == breeding_events.page %}
          <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="{{ url_for('goats.goat_detail', tag=goat.tag, breeding_page=page_num) }}#breeding">{{ page_num }}</a></li>
        {% endif %}
      {% else %}
        <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
      {% endif %}
    {% endfor %}
    {% if breeding_events.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('goats.goat_detail', tag=goat.tag, breeding_page=breeding_events.next_num) }}#breeding">Next</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<!-- Sickness history -->
<h3>Sickness History</h3>
<table class="table table-striped">
  <thead>
    <tr>
      <th>Date</th>
      <th>Sickness</th>
      <th>Medicine</th>
      <th>Status</th>
      <th>Notes</th>
      <th>Photo(s)</th>
    </tr>
  </thead>
  <tbody>
    {% for log in sickness_history.items %}
    <tr>
      <td>{{ log.date }}</td>
      <td>{{ log.sickness }}</td>
      <td>{{ log.medicine }}</td>
      <td>
        {% if log.status == 'active' %}
          <span class="badge bg-danger">Sick</span>
          <form method="post" action="{{ url_for('sickness.mark_sickness_recovered', log_id=log.id) }}" style="display:inline;">
            <button type="submit" class="btn btn-sm btn-outline-success ms-1">Mark as Recovered</button>
          </form>
        {% else %}
          <span class="badge bg-success">Recovered</span>
        {% endif %}
      </td>
      <td>{{ log.notes or '-' }}</td>
      <td>
        {% if log.photos %}
          {% for photo in log.photos %}
            <img src="{{ '/' ~ photo.image_path }}"
                alt="Sick photo"
                class="photo-thumb-img"
                style="max-width:60px;max-height:60px;border-radius:8px;cursor:pointer"
                data-bs-toggle="modal"
                data-bs-target="#imgModal"
                data-img="{{ '/' ~ photo.image_path }}"
                data-photo-id="{{ photo.id }}">
          {% endfor %}
        {% else %}
          <span class="text-muted">No photo</span>
        {% endif %}
      </td>
    </tr>
    {% else %}
    <tr>
      <td colspan="6" class="text-muted">No sickness logs yet.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<nav>
  <ul class="pagination justify-content-center">
    {% if sickness_history.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('goats.goat_detail', tag=goat.tag, sickness_page=sickness_history.prev_num) }}#sickness">Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}
    {% for page_num in sickness_history.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
      {% if page_num %}
        {% if page_num == sickness_history.page %}
          <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="{{ url_for('goats.goat_detail', tag=goat.tag, sickness_page=page_num) }}#sickness">{{ page_num }}</a></li>
        {% endif %}
      {% else %}
        <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
      {% endif %}
    {% endfor %}
    {% if sickness_history.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('goats.goat_detail', tag=goat.tag, sickness_page=sickness_history.next_num) }}#sickness">Next</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>

<h3>Observation/Discussion</h3>
<!-- Button to trigger modal -->
<button class="btn btn-outline-success mb-3" data-bs-toggle="modal" data-bs-target="#feedbackModal">
  ‚ûï Submit Feedback
</button>

<!-- Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('goats.add_goat_feedback', tag=goat.tag) }}" enctype="multipart/form-data" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feedbackModalLabel">Submit Feedback for {{ goat.tag }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="feedbackContent" class="form-label">Your Feedback</label>
          <input type="text" name="content" id="feedbackContent" class="form-control" placeholder="Enter remark..." required maxlength="300">
        </div>
        <div class="mb-3">
          <label for="photo" class="form-label">Photo (optional)</label>
          <input type="file" name="photos" class="form-control" accept="image/*" capture="environment" multiple>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Submit</button>
      </div>
    </form>
  </div>
</div>

<ul class="list-group mb-4">
  {% for fb in goat.feedbacks|sort(attribute='timestamp', reverse=True) %}
    <li class="list-group-item">
      <div class="fw-bold">
        {{ fb.submitted_by }}
        <small class="text-muted">{{ fb.timestamp.strftime('%d-%m-%Y %H:%M') }}</small>
      </div>

      <div>{{ fb.content }}</div>

      {% if fb.photos %}
        <div class="d-flex flex-wrap gap-1 mt-2">
          {% for photo in fb.photos %}
            <img src="{{ '/' ~ photo.image_path }}"
                 class="photo-thumb-img"
                 style="max-height:100px; border-radius:8px; cursor:pointer"
                 data-bs-toggle="modal"
                 data-bs-target="#imgModal"
                 data-img="{{ '/' ~ photo.image_path }}"
                 data-photo-id="{{ photo.id }}"
                 data-delete-url="{{ url_for('dashboard.delete_feedback_photo', photo_id=photo.id) }}">
          {% endfor %}
        </div>
      {% endif %}

      {% if fb.submitted_by == session.username and (now - fb.timestamp).total_seconds() < 3600 %}
        <!-- ‚úè Edit Button -->
        <button class="btn btn-sm btn-outline-primary mt-2" data-bs-toggle="modal" data-bs-target="#editFbModal-{{ fb.id }}">
          ‚úè Edit
        </button>

        <!-- üóë Delete Button -->
        <form method="POST"
              action="{{ url_for('goats.delete_goat_feedback', tag=goat.tag, fb_id=fb.id) }}"
              class="d-inline"
              onsubmit="return confirm('Are you sure you want to delete this feedback?');">
          <button type="submit" class="btn btn-sm btn-outline-danger mt-2">üóë Delete</button>
        </form>

        <!-- üìù Edit Modal -->
        <div class="modal fade" id="editFbModal-{{ fb.id }}" tabindex="-1" aria-labelledby="editFbModalLabel-{{ fb.id }}" aria-hidden="true">
          <div class="modal-dialog">
            <form method="POST" action="{{ url_for('goats.edit_goat_feedback', tag=goat.tag, fb_id=fb.id) }}" class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editFbModalLabel-{{ fb.id }}">Edit Feedback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <textarea name="edit_content" class="form-control" rows="3" maxlength="300" required>{{ fb.content }}</textarea>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Update</button>
              </div>
            </form>
          </div>
        </div>
      {% endif %}
    </li>
  {% else %}
    <li class="list-group-item text-muted">No remarks yet.</li>
  {% endfor %}
</ul>


<!-- Modal for image preview -->
<div class="modal fade" id="imgModal" tabindex="-1" aria-labelledby="imgModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imgModalLabel">Sickness Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalImg" src="" alt="Preview" style="max-width:100%;max-height:70vh;border-radius:12px;">
        <form id="deletePhotoForm" method="post" action="" class="mt-3" style="display:none">
          <input type="hidden" name="next" value="">
          <button type="submit" class="btn btn-danger">Delete Photo</button>
        </form>
      </div>
    </div>
  </div>
</div>


<a href="{{ url_for('goats.list_goats') }}" class="btn btn-secondary mt-2">Back to Goat List</a>


{% block scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", function() {
  // --- Vaccine Reschedule via AJAX ---
  {% for v in vaccine_due_info %}
    var form = document.getElementById("rescheduleForm-{{ v.vaccine.id }}-{{ v.next_due.strftime('%Y%m%d') }}");
    if (form) {
      form.onsubmit = function(e) {
        e.preventDefault();
        var modalId = "rescheduleModal-{{ v.vaccine.id }}-{{ v.next_due.strftime('%Y%m%d') }}";
        var modalEl = document.getElementById(modalId);
        var bsModal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        var formData = new FormData(form);
        fetch(form.action, {
          method: "POST",
          body: new URLSearchParams(formData),
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            bsModal.hide();
            showSuccessAlert(data.message || "Rescheduled!");
            setTimeout(() => location.reload(), 1200);
          } else {
            showErrorAlert(data.error || "Failed to reschedule.");
          }
        })
        .catch(() => {
          showErrorAlert("Server error. Please try again.");
        });
      }
    }
  {% endfor %}

  // --- Image Modal Preview + Delete (for sickness & feedback) ---
  const modal = document.getElementById('imgModal');
  const modalImg = document.getElementById('modalImg');
  const deleteForm = document.getElementById('deletePhotoForm');

  modal.addEventListener('show.bs.modal', function (event) {
    const trigger = event.relatedTarget;
    const imgSrc = trigger.getAttribute("data-img");
    const deleteUrl = trigger.getAttribute("data-delete-url");

    modalImg.src = imgSrc;
    if (deleteUrl) {
      deleteForm.action = deleteUrl;
      deleteForm.style.display = "";
      deleteForm.querySelector("input[name='next']").value = window.location.pathname + window.location.search;
    } else {
      deleteForm.action = "";
      deleteForm.style.display = "none";
    }
  });

  modal.addEventListener('hidden.bs.modal', function () {
    modalImg.src = '';
    deleteForm.action = '';
    deleteForm.style.display = 'none';
  });

  deleteForm.onsubmit = function() {
    return confirm("Delete this photo?");
  };

  // --- Alert Helpers ---
function showSuccessAlert(msg) {
  const alert = document.createElement("div");
  alert.className = "alert alert-success alert-dismissible fade show alert-floating";
  alert.role = "alert";
  alert.innerHTML = msg + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
  document.body.appendChild(alert);
  setTimeout(() => alert.remove(), 2500);
}

function showErrorAlert(msg) {
  const alert = document.createElement("div");
  alert.className = "alert alert-danger alert-dismissible fade show alert-floating";
  alert.role = "alert";
  alert.innerHTML = msg + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
  document.body.appendChild(alert);
  setTimeout(() => alert.remove(), 3000);
}

});
</script>
{% endblock %}

{% endblock %}